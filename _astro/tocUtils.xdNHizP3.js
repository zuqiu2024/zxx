class h{tocItems=[];observer=null;minDepth=10;maxLevel;scrollTimeout=null;contentId;indicatorId;scrollOffset;constructor(t){this.contentId=t.contentId,this.indicatorId=t.indicatorId,this.maxLevel=t.maxLevel||3,this.scrollOffset=t.scrollOffset||80}getContentContainer(){return document.querySelector(".custom-md")||document.querySelector(".prose")||document.querySelector(".markdown-content")}getAllHeadings(){const t=this.getContentContainer();return t?t.querySelectorAll("h1, h2, h3, h4, h5, h6"):document.querySelectorAll("h1, h2, h3, h4, h5, h6")}calculateMinDepth(t){let e=10;return t.forEach(i=>{const n=Number.parseInt(i.tagName.charAt(1),10);e=Math.min(e,n)}),e}filterHeadings(t){return Array.from(t).filter(e=>Number.parseInt(e.tagName.charAt(1),10)<this.minDepth+this.maxLevel)}generateBadgeContent(t,e){return t===this.minDepth?e.toString():t===this.minDepth+1?'<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>':'<div class="transition w-1.5 h-1.5 rounded-sm bg-black/5 dark:bg-white/10"></div>'}generateTOCHTML(){const t=this.getAllHeadings();if(t.length===0)return'<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';this.minDepth=this.calculateMinDepth(t);const e=this.filterHeadings(t);if(e.length===0)return'<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';let i="",n=1;return e.forEach(s=>{const o=Number.parseInt(s.tagName.charAt(1),10),r=o===this.minDepth?"":o===this.minDepth+1?"pl-4":"pl-8";if(!s.id)return;const c=this.generateBadgeContent(o,n);o===this.minDepth&&n++;const l=(s.textContent||"").replace(/#+\s*$/,"");i+=`
        <a 
          href="#${s.id}" 
          class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2 ${r}"
          data-heading-id="${s.id}"
        >
          <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${o===this.minDepth?"bg-[var(--toc-badge-bg)] text-[var(--btn-content)]":""}">
            ${c}
          </div>
          <div class="transition text-sm ${o<=this.minDepth+1?"text-50":"text-30"} flex-1 min-w-0 overflow-hidden text-ellipsis whitespace-nowrap">${l}</div>
        </a>
      `}),i+=`<div id="${this.indicatorId}" style="opacity: 0;" class="-z-10 absolute bg-[var(--toc-btn-hover)] left-0 right-0 rounded-xl transition-all"></div>`,i}updateTOCContent(){const t=document.getElementById(this.contentId);t&&(t.innerHTML=this.generateTOCHTML(),this.tocItems=Array.from(document.querySelectorAll(`#${this.contentId} a`)))}getVisibleHeadingIds(){const t=this.getAllHeadings(),e=[];if(t.forEach(i=>{if(i.id){const n=i.getBoundingClientRect();n.top<window.innerHeight&&n.bottom>0&&e.push(i.id)}}),e.length===0&&t.length>0){let i=null,n=Number.POSITIVE_INFINITY;t.forEach(s=>{if(s.id){const o=s.getBoundingClientRect(),r=Math.abs(o.top);r<n&&(n=r,i=s.id)}}),i&&e.push(i)}return e}updateActiveState(){if(!this.tocItems||this.tocItems.length===0)return;this.tocItems.forEach(i=>{i.classList.remove("visible")});const t=this.getVisibleHeadingIds(),e=this.tocItems.filter(i=>{const n=i.dataset.headingId;return n&&t.includes(n)});e.forEach(i=>{i.classList.add("visible")}),this.updateActiveIndicator(e)}updateActiveIndicator(t){const e=document.getElementById(this.indicatorId);if(!e||!this.tocItems.length)return;if(t.length===0){e.style.opacity="0";return}const i=document.getElementById(this.contentId);if(!i)return;const n=i.getBoundingClientRect(),s=t[0],o=t[t.length-1],r=s.getBoundingClientRect(),c=o.getBoundingClientRect(),l=r.top-n.top,a=c.bottom-r.top;e.style.top=`${l}px`,e.style.height=`${a}px`,e.style.opacity="1",s&&this.scrollToActiveItem(s)}scrollToActiveItem(t){if(!t)return;const e=document.querySelector(`#${this.contentId}`)?.closest(".toc-scroll-container");e&&(this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=window.setTimeout(()=>{const i=e.getBoundingClientRect(),n=t.getBoundingClientRect();if(!(n.top>=i.top&&n.bottom<=i.bottom)){const o=t.offsetTop,r=e.clientHeight,c=t.clientHeight,l=o-r/2+c/2;e.scrollTo({top:l,behavior:"smooth"})}},100))}handleClick(t){t.preventDefault();const e=t.currentTarget,i=decodeURIComponent(e.getAttribute("href")?.substring(1)||""),n=document.getElementById(i);if(n){const s=n.getBoundingClientRect().top+window.pageYOffset-this.scrollOffset;window.scrollTo({top:s,behavior:"smooth"})}}setupObserver(){const t=this.getAllHeadings();this.observer&&this.observer.disconnect(),this.observer=new IntersectionObserver(()=>{this.updateActiveState()},{rootMargin:"0px 0px 0px 0px",threshold:0}),t.forEach(e=>{e.id&&this.observer?.observe(e)})}bindClickEvents(){this.tocItems.forEach(t=>{t.addEventListener("click",this.handleClick.bind(this))})}cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null),this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null)}init(){this.updateTOCContent(),this.bindClickEvents(),this.setupObserver(),this.updateActiveState()}}function u(){return window.location.pathname.includes("/posts/")}export{h as T,u as i};
